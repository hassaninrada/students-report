<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasra Portal — Academics & Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #f9fafb;
            font-family: 'Segoe UI', sans-serif;
        }

        .fadeIn {
            animation: fadeIn .25s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        input,
        select,
        textarea {
            outline: none;
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
        }

        .chart-card {
            width: 280px;
            height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="min-h-screen p-4">
    <header
        class="bg-gradient-to-r from-blue-700 to-blue-800 text-white shadow rounded-lg p-4 mb-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://i-care-foundation.org/wp-content/uploads/2024/12/education-trust-nasra-schools-logo.png"
                class="w-12 h-12 rounded-lg border-2 border-white" />
            <div>
                <h1 class="text-2xl font-bold">NASRA SCHOOL</h1>
                <p class="text-xs opacity-90">Student Report Portal</p>
            </div>
        </div>
        <div class="flex gap-3">
            <a href="about-student.html"
                class="bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-500 transition text-white no-underline flex items-center gap-2">
                <i class="fa-solid fa-user-tie"></i> About Developer
            </a>
            <button onclick="goHome()" class="bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-500 transition">Portal
                Home</button>
        </div>
    </header>

    <!-- ROLE GATE -->
    <section id="roleGate" class="max-w-5xl mx-auto p-8 fadeIn">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-black text-gray-800 tracking-tight">Access Your Portal</h2>
            <p class="text-gray-500 mt-2">Choose the appropriate gateway to manage or view academic records.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Student/Parent Card -->
            <div
                class="group relative bg-white rounded-3xl p-8 shadow-xl transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl border border-gray-100 overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-green-500"></div>
                <div class="flex items-start justify-between mb-8">
                    <div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center text-green-600">
                        <i class="fa-solid fa-graduation-cap text-3xl"></i>
                    </div>
                    <span
                        class="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full uppercase tracking-widest">Public
                        Access</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Student & Parent Portal</h2>
                <p class="text-gray-500 text-sm leading-relaxed mb-8">Securely search and download official progress
                    reports. Requires student CID or Registration details.</p>
                <button id="enterParent" onclick="showParentPortal()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl transition-all shadow-lg shadow-green-200 flex items-center justify-center gap-2 group">
                    <span>Enter Search Portal</span>
                    <i class="fa-solid fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                </button>
            </div>

            <!-- Teacher/Faculty Card -->
            <div
                class="group relative bg-white rounded-3xl p-8 shadow-xl transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl border border-gray-100 overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                <div class="flex items-start justify-between mb-8">
                    <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600">
                        <i class="fa-solid fa-chalkboard-user text-3xl"></i>
                    </div>
                    <span
                        class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase tracking-widest">Authorized
                        Only</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Faculty Management</h2>
                <p class="text-gray-500 text-sm leading-relaxed mb-8">Authorized access for teachers to record marks,
                    manage attendance, and update performance remarks.</p>

                <div class="flex gap-4 mb-4">
                    <button id="enterTeacherPrimary" onclick="teacherEntry('Primary')"
                        class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl text-sm transition-all">Primary
                        Wing</button>
                    <button id="enterTeacherSecondary" onclick="teacherEntry('Secondary')"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-sm transition-all">Secondary
                        Wing</button>
                </div>

                <div id="passArea" class="hidden animate-fade pt-4 border-t border-gray-100">
                    <input type="password" id="teacherPassInput" placeholder="Enter Faculty Security PIN"
                        class="w-full bg-gray-100 border-none rounded-xl px-4 py-4 mb-3 focus:ring-2 focus:ring-blue-500 transition-all font-mono" />
                    <button id="submitPass"
                        class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 rounded-xl shadow-lg transition-all">Verify
                        Credentials</button>
                    <p id="passError" class="text-red-500 text-xs font-bold mt-2 hidden text-center italic">⚠️ Access
                        Denied: Incorrect Security Pin</p>
                </div>
            </div>
        </div>
    </section>

    <!-- PARENT PORTAL -->
    <section id="parentPortal" class="max-w-7xl mx-auto p-4 hidden fadeIn">
        <div class="card mb-6">
            <h2 class="card-header text-blue-800"><i class="fa-solid fa-magnifying-glass"></i> Student Record Search
            </h2>
            <div class="grid md:grid-cols-4 gap-3">
                <input id="ppName" placeholder="Student Name" class="border p-2 rounded" />
                <input id="ppClass" placeholder="Class" class="border p-2 rounded" />
                <input id="ppSection" placeholder="Section" class="border p-2 rounded" />
                <button id="ppSearchBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold uppercase text-sm">Find
                    Records</button>
            </div>
            <div class="mt-4">
                <select id="ppSelectStudent" class="border p-2 rounded w-full md:w-1/2"></select>
            </div>
        </div>

        <div id="ppResultsWrap" class="hidden fadeIn">
            <div id="pdfContent"
                class="bg-white p-12 rounded-lg shadow-2xl border-4 border-double border-blue-900 relative"
                style="width: 210mm; min-height: 280mm; margin: 0 auto;">
                <!-- Decorative Watermark -->
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 8rem; color: rgba(0,0,0,0.03); font-weight: 900; pointer-events: none; white-space: nowrap;">
                    NASRA SCHOOL</div>

                <div class="text-center mb-10 pb-6 border-b-2 border-blue-900">
                    <img src="https://nasraschool.edu.pk/wp-content/uploads/2024/03/logo.webp" class="w-32 mx-auto mb-4"
                        alt="Nasra Logo" />
                    <h1 class="text-4xl font-extrabold text-blue-900 tracking-tighter">EDUCATION TRUST NASRA SCHOOL</h1>
                    <p class="text-sm font-semibold text-blue-700 tracking-widest mt-1 uppercase">Official Academic
                        Progress Report</p>
                </div>

                <div class="grid grid-cols-2 gap-8 mb-10 text-lg">
                    <div class="space-y-2 p-4 bg-blue-50 rounded-xl border border-blue-100" id="ppStudentMeta">
                        <!-- Filled by JS -->
                    </div>
                    <div class="text-right flex flex-col justify-center">
                        <p class="text-gray-500 font-bold uppercase text-xs tracking-widest">Date of Issue</p>
                        <p class="text-xl font-bold text-gray-800" id="issueDate"></p>
                    </div>
                </div>

                <div class="mb-10">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center gap-2">
                        <span
                            class="w-8 h-8 bg-blue-900 text-white rounded-full flex items-center justify-center text-sm">01</span>
                        ACADEMIC ASSESSMENT
                    </h3>
                    <div class="overflow-hidden rounded-xl border border-gray-200">
                        <table id="ppMarksTable" class="w-full text-left">
                            <thead class="bg-blue-900 text-white text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">Examination Term</th>
                                    <th class="p-4">Subject</th>
                                    <th class="p-4 text-center">Score</th>
                                    <th class="p-4 text-center">Grade</th>
                                    <th class="p-4 text-right">Result</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-gray-100">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8 mb-10">
                    <div class="p-6 bg-gray-50 rounded-2xl border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span
                                class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs">02</span>
                            FACULTY REMARKS
                        </h3>
                        <div id="ppRemarks" class="text-gray-600 italic leading-relaxed min-h-[80px]"></div>
                    </div>
                    <div
                        class="p-6 bg-blue-900 rounded-2xl text-white text-center flex flex-col justify-center shadow-lg">
                        <p class="text-xs font-bold opacity-60 uppercase mb-2">Overall Attendance</p>
                        <div id="ppAttendanceDisplay" class="text-5xl font-black">0%</div>
                        <p class="text-[10px] opacity-40 mt-2">Verified by Administrative Office</p>
                    </div>
                </div>

                <div id="termChartsWrap"
                    class="flex flex-wrap gap-6 justify-center pt-8 border-t border-dashed border-gray-300">
                    <!-- Charts -->
                </div>

                <div class="mt-12 pt-8 flex justify-between items-end">
                    <div class="text-center w-48">
                        <div class="border-b border-gray-400 mb-2"></div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase">Class Teacher Signature</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[8px] text-gray-400 mb-2 italic">This is an electronically generated report and
                            requires no manual stamp.</p>
                        <p class="text-[10px] font-bold text-blue-900">SYSTEM VERIFIED: NASRA-E-PORTAL</p>
                    </div>
                    <div class="text-center w-48">
                        <div class="border-b border-gray-400 mb-2"></div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase">Principal's Signature</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="ppExportPDF"
                    class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 shadow-lg font-bold">
                    <i class="fa-solid fa-file-pdf"></i> Download Official Report (PDF)
                </button>
            </div>
        </div>
    </section>

    <!-- TEACHER PORTAL -->
    <section id="teacherPortal" class="max-w-7xl mx-auto p-4 hidden fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Dashboard: <span id="portalWingLabel" class="text-blue-600"></span></h2>
            <button onclick="goHome()" class="bg-gray-200 px-4 py-2 rounded text-sm hover:bg-gray-300">Exit
                Portal</button>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="card mb-6">
                    <h3 class="card-header">Student Management</h3>
                    <div class="grid md:grid-cols-4 gap-2 mb-4">
                        <input id="tName" class="border rounded-lg px-3 py-2 text-sm" placeholder="Full Name" />
                        <input id="tClass" class="border rounded-lg px-3 py-2 text-sm" placeholder="Class" />
                        <input id="tSection" class="border rounded-lg px-3 py-2 text-sm" placeholder="Section" />
                        <input id="tCID" class="border rounded-lg px-3 py-2 text-sm" placeholder="CID/GR Number" />
                    </div>
                    <div class="flex gap-2">
                        <button id="addStudent"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg flex-1 hover:bg-green-700"><i
                                class="fa-solid fa-user-plus"></i> Single Add</button>
                        <button id="deleteStudent"
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"><i
                                class="fa-solid fa-trash"></i> Delete</button>
                    </div>
                </div>

                <div class="card border-t-4 border-blue-600 mb-6">
                    <h3 class="card-header text-blue-700"><i class="fa-solid fa-file-excel"></i> Bulk CSV/Excel Upload
                    </h3>
                    <p class="text-xs text-gray-500 mb-3">Include headers: Name, Class, Section, CID</p>
                    <div class="flex gap-2 items-center">
                        <input type="file" id="bulkFileInput" accept=".xlsx, .xls, .csv"
                            class="border p-1 text-sm rounded bg-gray-50 w-full" />
                        <button id="processBulkBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded text-sm whitespace-nowrap">Upload
                            All</button>
                    </div>
                    <div id="bulkStatus" class="mt-2 text-xs font-bold italic"></div>
                </div>

                <div class="card">
                    <h3 class="card-header">Grading & Assessment</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">SELECT STUDENT</label>
                            <select id="selectStudentTeacher" class="border rounded-lg px-3 py-2 w-full"></select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">TARGET TERM</label>
                            <select id="selectTerm" class="border rounded-lg px-3 py-2 w-full">
                                <option>First Term</option>
                                <option>Mid Term</option>
                                <option>Second Term</option>
                                <option>Final Term</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">SUBJECT</label>
                            <select id="selectSubject" class="border rounded-lg px-3 py-2 w-full"></select>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <input type="number" id="inputMarks" placeholder="Marks Obtained"
                            class="border rounded-lg px-3 py-2" />
                        <input type="number" id="inputAttendance" placeholder="Attendance %"
                            class="border rounded-lg px-3 py-2" />
                    </div>
                    <textarea id="inputRemarks" class="border rounded-lg px-3 py-2 w-full mb-4"
                        placeholder="Student performance remarks..."></textarea>
                    <button id="saveMarks"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 w-full font-bold">COMMIT
                        CHANGES</button>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="card h-full">
                    <h3 class="card-header">Subject Settings</h3>
                    <div id="subjectContainer" class="space-y-2 mb-4"></div>
                    <button id="addSubjectBtn"
                        class="w-full border-2 border-dashed border-purple-300 text-purple-600 py-2 rounded hover:bg-purple-50"><i
                            class="fa-solid fa-plus"></i> Add New Subject</button>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Initialization
        const supabaseUrl = 'https://fsmxmfkydxbqnofsojsq.supabase.co';
        const supabaseKey = 'sb_publishable__Z2iWVPqz6Xw947CH_YLUg_YhoLeseh';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const teacherPrimaryPass = "primary123";
        const teacherSecondaryPass = "secondary123";
        const teacherPassword = "teacher123";

        let currentTeacherMode = "";
        let teacherSubjects = JSON.parse(localStorage.getItem("teacherSubjects") || JSON.stringify(["English", "Math", "Science", "SST"]));
        const termMax = { "First Term": 25, "Mid Term": 50, "Second Term": 75, "Final Term": 100 };

        window.goHome = function () {
            document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
            document.getElementById("roleGate").classList.remove("hidden");
            currentTeacherMode = "";
        };

        function getGradeFinal(m) { if (m >= 90) return "A+"; if (m >= 80) return "A"; if (m >= 70) return "B"; if (m >= 60) return "C"; if (m >= 50) return "D"; if (m >= 40) return "E"; return "F"; }
        function getResultTerm(m, term) { let max = termMax[term]; return m >= 0.4 * max ? "Pass" : "Fail"; }

        let pendingMode = "";

        window.teacherEntry = function (mode) {
            pendingMode = mode;
            showPassInput();
        };

        window.showParentPortal = function () {
            document.getElementById("roleGate").classList.add("hidden");
            document.getElementById("parentPortal").classList.remove("hidden");
        };

        function showPassInput() {
            document.getElementById("passArea").classList.remove("hidden");
            document.getElementById("teacherPassInput").value = "";
            document.getElementById("teacherPassInput").focus();
            document.getElementById("passError").classList.add("hidden");
        }

        document.getElementById("submitPass").addEventListener("click", () => {
            const val = document.getElementById("teacherPassInput").value;
            if ((pendingMode === "Primary" && val === teacherPrimaryPass) || (pendingMode === "Secondary" && val === teacherSecondaryPass) || val === teacherPassword) {
                currentTeacherMode = pendingMode;
                document.getElementById("portalWingLabel").textContent = currentTeacherMode;
                document.getElementById("roleGate").classList.add("hidden");
                document.getElementById("teacherPortal").classList.remove("hidden");
                renderSubjects();
                updateTeacherStudentList();
                updateTeacherSubjectDropdown();
            } else {
                document.getElementById("passError").classList.remove("hidden");
            }
        });

        // BULK UPLOAD
        document.getElementById("processBulkBtn").addEventListener("click", async () => {
            const file = document.getElementById("bulkFileInput").files[0];
            const status = document.getElementById("bulkStatus");
            if (!file) return alert("Select file");
            status.textContent = "Processing...";
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    const wing = currentTeacherMode || "Primary";
                    const toInsert = jsonData.map(row => {
                        const find = (k) => { let key = Object.keys(row).find(x => k.includes(x.toLowerCase().trim())); return key ? String(row[key]).trim() : ""; };
                        return {
                            name: find(["name", "student name"]), cls: find(["class", "grade"]), sec: find(["section"]), cid: find(["cid", "gr"]),
                            wing, marks: {}, attendance: 0, remarks: "", voted_primary: false, voted_secondary: false
                        };
                    }).filter(s => s.cid && s.name);
                    const { error } = await supabaseClient.from('students').upsert(toInsert, { onConflict: 'cid' });
                    if (error) throw error;
                    status.textContent = "✅ Upload Successful!";
                    updateTeacherStudentList();
                } catch (err) { status.textContent = "❌ " + err.message; }
            };
            reader.readAsArrayBuffer(file);
        });

        function renderSubjects() {
            const container = document.getElementById("subjectContainer"); container.innerHTML = "";
            teacherSubjects.forEach((sub, i) => {
                const div = document.createElement("div"); div.className = "flex items-center justify-between bg-white border p-2 rounded shadow-sm";
                div.innerHTML = `<span>${sub}</span><button class="text-red-500 hover:text-red-700 text-sm">Remove</button>`;
                div.querySelector("button").onclick = () => { teacherSubjects.splice(i, 1); saveSubs(); };
                container.appendChild(div);
            });
        }
        function saveSubs() { localStorage.setItem("teacherSubjects", JSON.stringify(teacherSubjects)); renderSubjects(); updateTeacherSubjectDropdown(); }
        document.getElementById("addSubjectBtn").onclick = () => { let s = prompt("Subject Name:"); if (s) { teacherSubjects.push(s); saveSubs(); } };

        document.getElementById("addStudent").onclick = async () => {
            const data = { name: document.getElementById("tName").value, cls: document.getElementById("tClass").value, sec: document.getElementById("tSection").value, cid: document.getElementById("tCID").value, wing: currentTeacherMode, marks: {}, attendance: 0, remarks: "", voted_primary: false, voted_secondary: false };
            if (!data.name || !data.cid) return alert("Missing Info");
            const { error } = await supabaseClient.from('students').insert([data]);
            if (error) alert(error.message); else { alert("Added"); updateTeacherStudentList(); }
        };

        document.getElementById("deleteStudent").onclick = async () => {
            if (!confirm("Delete?")) return;
            const cid = document.getElementById("tCID").value;
            await supabaseClient.from('students').delete().eq('cid', cid);
            updateTeacherStudentList();
        };

        async function updateTeacherStudentList() {
            const { data } = await supabaseClient.from('students').select('*').eq('wing', currentTeacherMode);
            const sel = document.getElementById("selectStudentTeacher"); sel.innerHTML = "";
            data?.forEach(s => { sel.innerHTML += `<option value="${s.cid}">${s.name} (${s.cid})</option>`; });
        }
        function updateTeacherSubjectDropdown() {
            const sel = document.getElementById("selectSubject"); sel.innerHTML = "";
            teacherSubjects.forEach(s => { sel.innerHTML += `<option>${s}</option>`; });
        }

        document.getElementById("saveMarks").onclick = async () => {
            const cid = document.getElementById("selectStudentTeacher").value;
            const res = await supabaseClient.from('students').select('*').eq('cid', cid).single();
            const student = res.data;
            const sub = document.getElementById("selectSubject").value;
            const term = document.getElementById("selectTerm").value;
            student.marks[sub] = student.marks[sub] || {};
            student.marks[sub][term] = Number(document.getElementById("inputMarks").value);
            await supabaseClient.from('students').update({ marks: student.marks, attendance: Number(document.getElementById("inputAttendance").value), remarks: document.getElementById("inputRemarks").value }).eq('cid', cid);
            alert("Saved");
        };

        // PARENT PORTAL SEARCH
        document.getElementById("ppSearchBtn").onclick = async () => {
            const name = document.getElementById("ppName").value;
            const cls = document.getElementById("ppClass").value;
            const sec = document.getElementById("ppSection").value;

            let query = supabaseClient.from('students').select('*');

            if (name) query = query.ilike('name', `%${name}%`);
            if (cls) query = query.eq('cls', cls);
            if (sec) query = query.eq('sec', sec);

            const { data, error } = await query;
            if (error) {
                console.error("Search error:", error);
                return;
            }

            const sel = document.getElementById("ppSelectStudent");
            sel.innerHTML = "";
            data.forEach(s => {
                sel.innerHTML += `<option value="${s.cid}">${s.name} (${s.cls}-${s.sec})</option>`;
            });
            if (sel.value) displayStudent(sel.value);
        };

        async function displayStudent(cid) {
            const { data: s } = await supabaseClient.from('students').select('*').eq('cid', cid).single();
            if (!s) return;
            document.getElementById("ppResultsWrap").classList.remove("hidden");

            // Set Issue Date
            document.getElementById("issueDate").textContent = new Date().toLocaleDateString('en-GB', {
                day: '2-digit', month: 'long', year: 'numeric'
            });

            // Populate Meta Data with Premium Styling
            document.getElementById("ppStudentMeta").innerHTML = `
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-blue-900 uppercase opacity-50">Student Name</span>
                    <span class="font-bold text-blue-900">${s.name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-blue-900 uppercase opacity-50">Class & Section</span>
                    <span class="font-bold text-blue-900">${s.cls} - ${s.sec}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-blue-900 uppercase opacity-50">Registration Number</span>
                    <span class="font-bold text-blue-900">#${s.cid}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-blue-900 uppercase opacity-50">Academic Wing</span>
                    <span class="font-bold text-blue-900">${s.wing}</span>
                </div>
            `;

            document.getElementById("ppRemarks").textContent = s.remarks || "Student's performance has been satisfactory. Keep up the consistent effort.";
            document.getElementById("ppAttendanceDisplay").textContent = (s.attendance || 0) + "%";

            const tbody = document.querySelector("#ppMarksTable tbody"); tbody.innerHTML = "";
            teacherSubjects.forEach(sub => {
                ["First Term", "Mid Term", "Second Term", "Final Term"].forEach(term => {
                    const val = s.marks[sub]?.[term] || 0;
                    const grade = term === 'Final Term' ? getGradeFinal(val) : '-';
                    const res = getResultTerm(val, term);
                    const resColor = res === "Pass" ? "text-green-600" : "text-red-600";

                    tbody.innerHTML += `
                        <tr class="hover:bg-blue-50 transition-colors">
                            <td class="p-4 font-semibold text-gray-700">${term}</td>
                            <td class="p-4 text-gray-600">${sub}</td>
                            <td class="p-4 text-center font-bold text-blue-900">${val}</td>
                            <td class="p-4 text-center font-black">${grade}</td>
                            <td class="p-4 text-right font-bold ${resColor}">${res}</td>
                        </tr>`;
                });
            });

            const wrap = document.getElementById("termChartsWrap"); wrap.innerHTML = "";
            ["First Term", "Mid Term", "Second Term", "Final Term"].forEach(term => {
                const total = teacherSubjects.length * termMax[term];
                let sum = 0; teacherSubjects.forEach(sub => sum += (s.marks[sub]?.[term] || 0));
                const pc = total > 0 ? Math.round((sum / total) * 100) : 0;
                const div = document.createElement("div"); div.className = "flex flex-col items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm";
                div.innerHTML = `<canvas width="100" height="100"></canvas><p class="mt-3 text-[10px] font-black text-blue-900 uppercase tracking-tighter">${term}</p>`;
                wrap.appendChild(div);
                new Chart(div.querySelector('canvas'), {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: ['P', 'R'],
                        datasets: [{
                            data: [pc, 100 - pc],
                            backgroundColor: ['#1e3a8a', '#f3f4f6'],
                            borderWidth: 0,
                            borderRadius: 10
                        }]
                    },
                    options: {
                        cutout: '80%',
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                formatter: () => pc + '%',
                                color: '#1e3a8a',
                                font: { weight: 'bold', size: 10 }
                            }
                        }
                    }
                });
            });
        }

        document.getElementById("ppSelectStudent").onchange = (e) => displayStudent(e.target.value);

        document.getElementById("ppExportPDF").onclick = async () => {
            const canvas = await html2canvas(document.getElementById("pdfContent"), { scale: 2 });
            const doc = new jspdf.jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 0, 0, 210, 297 * (canvas.height / canvas.width));
            doc.save('Student_Report.pdf');
        };
    </script>
    <script src='developer-credit.js'></script>
</body>

</html>
